# Opsgenie & PagerDuty Bidirectional Integration Proxy

A Python server that provides bidirectional synchronization between Opsgenie and PagerDuty platforms.

This integration is needed to receive Opsgenie Alerts generated by Adidas developers using Aspen (ServiceNow) ticketing system. Since now there is not Opsgenie to Opsgenie integration, we need a way to receive Kong P1/P2 alerts from Adidas developers. [Read the Kong P1/P2 process here](https://intranet.giantswarm.io/docs/product/managed-apps/connectivity/kong-adidas/).

This app runs in `operations` - `gazelle` and listen to Opsgenie using a webhook, the same it listen to PagerDuty through a webhook. Below it is defined the actions or events supported and how those are mapped.

## Features

- HTTP server that listens for webhooks from both Opsgenie and PagerDuty
- Creates PagerDuty incidents from Opsgenie alerts
- Synchronizes notes from Opsgenie to PagerDuty
- Synchronizes acknowledgement status in both directions

## Setup

### PagerDuty

1. Go to your PagerDuty account and create an API key with appropriate permissions
2. Identify the service ID you want to create incidents for
3. Create a webhook subscription pointing to your server's `/pd-webhook` endpoint
4. Generate a webhook secret and use it to secure your webhook endpoint
5. Add all configuration details to your `.env` file

### Opsgenie

1. Create an API key in Opsgenie with appropriate permissions
2. Set up a webhook integration in Opsgenie pointing to your server's `/ops-webhook` endpoint
3. Note the integration ID of the webhook
4. Add the API key and integration ID to your `.env` file

## Define .env file

Create a file like @.env-example that contains the variable got from previous step:

```
# PagerDuty Configuration
PAGERDUTY_API_KEY=your_pagerduty_api_key_here
PAGERDUTY_SERVICE_ID=your_pagerduty_service_id_here
PAGERDUTY_WEBHOOK_SECRET=your_pagerduty_webhook_secret_to_unwanted_requests
PAGERDUTY_EMAIL=automation_mail_account@example.com
PAGERDUTY_USER=automation #Avoids loops processing events from the same automation user

# Opsgenie Configuration
OPSGENIE_API_KEY=your_opsgenie_api_key_here
OPSGENIE_INTEGRATION_ID=intregation_id_to_avoid_unwanted_requests
```

## How it Works

Trying to follow the Pydantic style the code is structured to define all webhooks available in both platforms : PagerDuty and Adidas.

It uses two classes to handler every action/event received by the webhook. It also use the API key integration in each platform to perform actions into alerts or incident based on the action/event received.

## Supported Actions

The [procedure defined with Adidas](https://intranet.giantswarm.io/docs/product/managed-apps/connectivity/kong-adidas/) only require to map the following actions:

### Opsgenie

The action:

- `Create`: Creates a new incident in PagerDuty to pager our engineers.
- `AddNote`: Adds a note from Opsgenie Alert to the corresponding PagerDuty incident
- `Acknowledge`: Adds a note to the PagerDuty incident indicating who (from adidas) acknowledged the alert and acknowledge the alert as automation user (since it is a non existing user in PagerDuty).

### PagerDuty

The event:

- `incident.acknowledged`: Acknowledges the corresponding alert in Opsgenie to notify Adidas team who from us took the alert.
- `incident.unacknowledged`: Unacknowledges the corresponding alert in Opsgenie to trigger the escalation to Adidas L2 team (Kong team).
- `incident.annotated`: Adds notes from PagerDuty to the corresponding Opsgenie alert. It is the way we communicate with users.
- `incident.resolved`: It adds a note in the Opsgenie alert who from us resolved the PagerDuty incident but it does not close the Opsgenie Alert (It is Adidas responsability).

## Testing

You can test the webhook receivers using curl:

### Testing Opsgenie to PagerDuty:

```bash
# Test alert creation
curl -X POST -H "Content-Type: application/json" -d '{"action":"Create","alert":{"alertId":"test-123","message":"Test alert"},"integrationId":"ccb77fcc-3474-4ee3-8140-300926635ed1"}' http://localhost:5001/ops-webhook

# Test note addition
curl -X POST -H "Content-Type: application/json" -d '{"action":"AddNote","alert":{"alertId":"test-123","username":"test-user"},"note":"This is a test note","integrationId":"ccb77fcc-3474-4ee3-8140-300926635ed1"}' http://localhost:5001/ops-webhook

# Test acknowledgement
curl -X POST -H "Content-Type: application/json" -d '{"action":"Acknowledge","alert":{"alertId":"test-123","username":"test-user"},"integrationId":"ccb77fcc-3474-4ee3-8140-300926635ed1"}' http://localhost:5001/ops-webhook

# Test unacknowledgement
curl -X POST -H "Content-Type: application/json" -d '{"action":"UnAcknowledge","alert":{"alertId":"test-123","username":"test-user"},"integrationId":"ccb77fcc-3474-4ee3-8140-300926635ed1"}' http://localhost:5001/ops-webhook
```

### Testing PagerDuty to Opsgenie:

```bash
# Test acknowledge from PagerDuty
curl -X POST -H "Content-Type: application/json" \
  -d @examples/pd-webhook-acknowledge.json \
  http://localhost:5001/pd-webhook

# Test unacknowledge from PagerDuty
curl -X POST -H "Content-Type: application/json" \
  -d @examples/pd-webhook-unacknowledge.json \
  http://localhost:5001/pd-webhook

# Test note/annotation from PagerDuty
curl -X POST -H "Content-Type: application/json" \
  -d @examples/pd-webhook-note.json \
  http://localhost:5001/pd-webhook
```

Example payload files can be found in the [`examples/`](examples/) directory.

### Testing in local

You can run the application just `python app.py` after creating the `.env` with the values configured in Opsgenie and Pagerduty.

Then you can run ngrok `ngrok http 5001` and make sure the Opsgenie and Pagerduty webhook configuration point to the ngrok generated endpoint.

## License

[Apache 2.0 License](LICENSE)
